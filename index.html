<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مدیریت صندوق شخصی</title>
    
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SheetJS (xlsx) for Excel export -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- 5. Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            onSnapshot,
            query,
            where,
            addDoc,
            serverTimestamp
        };
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Global variables for Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- SVG Icons ---
        const PlusIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        );

        const ArrowUpIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l.293.293a1 1 0 001.414-1.414l-3-3z" clipRule="evenodd" />
            </svg>
        );

        const ArrowDownIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.707-4.707a1 1 0 001.414 1.414l3-3a1 1 0 00-1.414-1.414L11 10.586V7a1 1 0 10-2 0v3.586l-.293-.293a1 1 0 00-1.414 1.414l3 3z" clipRule="evenodd" />
            </svg>
        );

        const BackIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
        );

        const TrashIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400 hover:text-red-500" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
          </svg>
        );

        const RepeatIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-blue-500">
            <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
          </svg>
        );

        const ExcelIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 ml-2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v2.25l-2.607-1.303a1.125 1.125 0 01-.84-1.897l3.207-3.208a1.125 1.125 0 011.897-.84l1.303 2.607V7.5a1.5 1.5 0 00-1.5-1.5h-3a1.5 1.5 0 00-1.5 1.5v3.25l2.607 1.303a1.125 1.125 0 01.84 1.897l-3.207 3.208a1.125 1.125 0 01-1.897.84l-1.303-2.607V16.5a1.5 1.5 0 001.5 1.5h3a1.5 1.5 0 001.5-1.5v-3.25l-2.607-1.303a1.125 1.125 0 01-.84-1.897l3.207-3.208a1.125 1.125 0 011.897-.84l1.303 2.607V7.5a1.5 1.5 0 00-1.5-1.5h-3a1.5 1.5 0 00-1.5 1.5v3.25z" />
            </svg>
        );

        const EditIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400 hover:text-blue-500 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-4.597 4.597a1 1 0 01-.39.24l-3 1a1 1 0 01-1.21-1.21l1-3a1 1 0 01.24-.39l4.597-4.597zM11 6l2.914 2.914-4.597 4.597-1.123 1.123.61-.203 1.714-1.714.707-.707 1.414 1.414.707.707-1.714 1.714-.61.203.203-.61 1.414 1.414-1.714-1.714z" clipRule="evenodd" />
            </svg>
        );

        const ReportIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 ml-2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H21m-2.25 11.25H12M12 10.5h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H21m-2.25 11.25H12M12 10.5h1.5m-1.5 3h1.5m-1.5 3h1.5m-3-6H21m-2.25 11.25H12M12 10.5h1.5m-1.5 3h1.5m-1.5 3h1.5M12 12V6m0 0a3 3 0 00-3 3v2.25c0 1.24.47 2.455 1.402 3.387M12 6a3 3 0 013 3v2.25c0 1.24-.47 2.455-1.402 3.387M15.75 14.25v2.25a3 3 0 01-3 3h-1.5a3 3 0 01-3-3v-2.25m3-1.5h.75" />
            </svg>
        );

        // --- Main App Component ---
        function App() {
            const [funds, setFunds] = useState([]);
            const [selectedFundId, setSelectedFundId] = useState(null);
            const [isAddFundModalOpen, setAddFundModalOpen] = useState(false);
            const [isAddTransactionModalOpen, setAddTransactionModalOpen] = useState(false);
            const [isEditTransactionModalOpen, setEditTransactionModalOpen] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [isConfirmDeleteModalOpen, setConfirmDeleteModalOpen] = useState(false);
            const [isSetRecurringModalOpen, setIsSetRecurringModalOpen] = useState(false);
            const [isAutoReportModalOpen, setIsAutoReportModalOpen] = useState(false);
            const [fundToDeleteId, setFundToDeleteId] = useState(null);
            const [transactionType, setTransactionType] = useState('deposit');
            const [notification, setNotification] = useState('');
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);

            // Initialize Firebase and set up authentication
            useEffect(() => {
                try {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebase;
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    if (initialAuthToken) {
                        signInWithCustomToken(authInstance, initialAuthToken).then(userCredential => {
                             console.log("Signed in with custom token:", userCredential.user.uid);
                        }).catch(error => {
                            console.error("Error signing in with custom token:", error);
                            signInAnonymously(authInstance); // Fallback to anonymous
                        });
                    } else {
                        signInAnonymously(authInstance);
                    }

                    onAuthStateChanged(authInstance, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("Auth state changed, user ID:", user.uid);
                        } else {
                            setUserId(null);
                            console.log("Auth state changed, no user.");
                        }
                    });
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                }
            }, []);

            // Handle fetching data and listening for changes
            useEffect(() => {
                if (!db || !userId) return;

                const fundColRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/funds`);
                const q = firebase.query(fundColRef);
                
                const unsubscribe = firebase.onSnapshot(q, (querySnapshot) => {
                    const fundsData = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                    }));
                    setFunds(fundsData);
                    console.log("Funds data fetched and updated.");
                });

                return () => unsubscribe();
            }, [db, userId]);

            // Auto-deposit logic
            useEffect(() => {
                if (!db || !userId || funds.length === 0) return;

                const checkAndExecuteAutoDeposits = async () => {
                    const todayISO = new Date().toISOString().split('T')[0];
                    let updatedFunds = [...funds];
                    let newTransactionsCount = 0;
                    
                    const lastExecutionDocRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/meta/lastExecution`);
                    const lastExecutionDocSnap = await firebase.getDoc(lastExecutionDocRef);
                    const lastExecutionDate = lastExecutionDocSnap.exists() ? lastExecutionDocSnap.data().date : null;

                    if (lastExecutionDate === todayISO) {
                         return;
                    }

                    const lastDate = lastExecutionDate ? new Date(lastExecutionDate) : null;
                    const now = new Date();

                    const fundUpdates = updatedFunds.map(async (fund) => {
                        if (fund.recurrence) {
                            const { amount, frequency } = fund.recurrence;
                            let lastExecuted = fund.recurrence.lastExecutedDate;
                            if (lastExecuted === undefined) {
                                lastExecuted = todayISO;
                            }
                            
                            const lastExecutedDateObj = new Date(lastExecuted);
                            let transactionsToAdd = [];
                            let currentDate = new Date(lastExecutedDateObj);
                            
                            while (currentDate.getTime() < now.getTime()) {
                                let shouldAdd = false;
                                currentDate.setDate(currentDate.getDate() + 1);

                                if (frequency === 'daily') {
                                    shouldAdd = true;
                                } else if (frequency === 'weekly' && currentDate.getDay() === lastExecutedDateObj.getDay()) {
                                    shouldAdd = true;
                                } else if (frequency === 'monthly' && currentDate.getDate() === lastExecutedDateObj.getDate()) {
                                    shouldAdd = true;
                                }

                                if (shouldAdd) {
                                    const newTransaction = {
                                        id: Date.now() + Math.random(),
                                        type: 'auto_deposit',
                                        amount: Number(amount),
                                        description: `واریز خودکار (${
                                            frequency === 'daily' ? 'روزانه' : frequency === 'weekly' ? 'هفتگی' : 'ماهانه'
                                        })`,
                                        date: currentDate.toLocaleDateString('fa-IR'),
                                        timestamp: firebase.serverTimestamp()
                                    };
                                    transactionsToAdd.push(newTransaction);
                                    newTransactionsCount++;
                                }
                            }

                            if (transactionsToAdd.length > 0) {
                                const newTransactions = [...fund.transactions, ...transactionsToAdd];
                                const updatedRecurrence = {
                                    ...fund.recurrence,
                                    lastExecutedDate: todayISO
                                };

                                await firebase.setDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/funds`, fund.id), {
                                    ...fund,
                                    transactions: newTransactions,
                                    recurrence: updatedRecurrence,
                                });
                            }
                        }
                    });

                    await Promise.all(fundUpdates);

                    if (newTransactionsCount > 0) {
                        setNotification(`${newTransactionsCount} تراکنش خودکار با موفقیت انجام شد.`);
                    }

                    await firebase.setDoc(lastExecutionDocRef, { date: todayISO });
                };

                checkAndExecuteAutoDeposits();
            }, [funds, db, userId]);

            // --- Derived State ---
            const selectedFund = useMemo(() => {
                return funds.find(f => f.id === selectedFundId);
            }, [funds, selectedFundId]);

            // --- Helper Functions ---
            const formatCurrency = (amount) => {
                const safeAmount = typeof amount === 'number' ? amount : 0;
                return new Intl.NumberFormat('fa-IR').format(safeAmount) + ' تومان';
            };

            const calculateBalance = (transactions) => {
                if (!transactions) return 0;
                return transactions.reduce((acc, trans) => {
                    const safeAmount = typeof trans.amount === 'number' ? trans.amount : 0;
                    return trans.type === 'deposit' || trans.type === 'auto_deposit' ? acc + safeAmount : acc - safeAmount;
                }, 0);
            };

            // --- Event Handlers ---
            const handleAddFund = async (fundName) => {
                if (fundName.trim() === '' || !db || !userId) return;
                const newFund = {
                    name: fundName,
                    transactions: [],
                    recurrence: null,
                    createdAt: firebase.serverTimestamp(),
                };
                try {
                    await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/users/${userId}/funds`), newFund);
                    setAddFundModalOpen(false);
                } catch (e) {
                    console.error("Error adding fund:", e);
                }
            };

            const handleAddTransaction = async (amount, description) => {
                if (!amount || amount <= 0 || !selectedFund || !db || !userId) return;
                const newTransaction = {
                    type: transactionType,
                    amount: Number(amount),
                    description: description || (transactionType === 'deposit' ? 'واریز' : 'برداشت'),
                    date: new Date().toLocaleDateString('fa-IR'),
                    timestamp: firebase.serverTimestamp(),
                };
                
                const updatedTransactions = [...selectedFund.transactions, newTransaction];
                try {
                    await firebase.setDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/funds`, selectedFundId), {
                        ...selectedFund,
                        transactions: updatedTransactions,
                    });
                    setAddTransactionModalOpen(false);
                } catch (e) {
                    console.error("Error adding transaction:", e);
                }
            };

            const handleEditTransaction = async (transactionId, newAmount, newDescription) => {
                if (!selectedFund || !db || !userId) return;
                const updatedTransactions = selectedFund.transactions.map(trans => 
                    trans.id === transactionId ? { ...trans, amount: Number(newAmount), description: newDescription } : trans
                );
                try {
                    await firebase.setDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/funds`, selectedFundId), {
                        ...selectedFund,
                        transactions: updatedTransactions,
                    });
                    setEditTransactionModalOpen(false);
                    setEditingTransaction(null);
                } catch (e) {
                    console.error("Error editing transaction:", e);
                }
            };

            const handleDeleteFund = (fundId) => {
                setFundToDeleteId(fundId);
                setConfirmDeleteModalOpen(true);
            };

            const handleConfirmDelete = async () => {
                if (!db || !userId || !fundToDeleteId) return;
                try {
                    await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/funds`, fundToDeleteId));
                    setSelectedFundId(null);
                    setConfirmDeleteModalOpen(false);
                    setFundToDeleteId(null);
                } catch (e) {
                    console.error("Error deleting fund:", e);
                }
            };

            const handleSetRecurringTransaction = async (type, amount, frequency) => {
                if (!selectedFund || !db || !userId) return;
                const todayISO = new Date().toISOString().split('T')[0];

                // First deposit is done immediately
                const firstTransaction = {
                    type: 'auto_deposit',
                    amount: Number(amount),
                    description: `واریز خودکار اولیه (${frequency === 'daily' ? 'روزانه' : frequency === 'weekly' ? 'هفتگی' : 'ماهانه'})`,
                    date: new Date().toLocaleDateString('fa-IR'),
                    timestamp: firebase.serverTimestamp(),
                };

                const updatedTransactions = [...selectedFund.transactions, firstTransaction];
                const updatedRecurrence = { type, amount, frequency, lastExecutedDate: todayISO };

                try {
                    await firebase.setDoc(firebase.doc(db, `artifacts/${appId}/users/${userId}/funds`, selectedFundId), {
                        ...selectedFund,
                        transactions: updatedTransactions,
                        recurrence: updatedRecurrence,
                    });
                    setIsSetRecurringModalOpen(false);
                    setNotification('قانون دوره‌ای با موفقیت ثبت شد و اولین واریز انجام شد.');
                    setTimeout(() => setNotification(''), 3000);
                } catch (e) {
                    console.error("Error setting recurring transaction:", e);
                }
            };

            const handleExportToExcel = () => {
                if (funds.length === 0) {
                    setNotification('صندوقی برای گزارش‌گیری وجود ندارد.');
                    setTimeout(() => setNotification(''), 3000);
                    return;
                }
                
                const workbook = XLSX.utils.book_new();

                funds.forEach(fund => {
                    const dataForSheet = fund.transactions.map(trans => ({
                        'نوع تراکنش': trans.type === 'deposit' ? 'واریز' : trans.type === 'auto_deposit' ? 'واریز خودکار' : 'برداشت',
                        'مبلغ': trans.amount,
                        'توضیحات': trans.description,
                        'تاریخ': trans.date,
                    }));

                    dataForSheet.unshift({
                        'نوع تراکنش': 'موجودی کل',
                        'مبلغ': calculateBalance(fund.transactions),
                        'توضیحات': '',
                        'تاریخ': '',
                    });
                    
                    const worksheet = XLSX.utils.json_to_sheet(dataForSheet, {
                         header: ['نوع تراکنش', 'مبلغ', 'توضیحات', 'تاریخ']
                    });

                    XLSX.utils.book_append_sheet(workbook, worksheet, fund.name);
                });

                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                
                const data = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = `گزارش_صندوق‌های_شخصی_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                setNotification('فایل اکسل با موفقیت دانلود شد.');
                setTimeout(() => setNotification(''), 3000);
            };

            // Filter for transactions created by the auto-deposit feature for the report
            const autoTransactions = useMemo(() => {
                const allTransactions = funds.flatMap(fund => 
                    fund.transactions.filter(t => t.type === 'auto_deposit').map(t => ({
                        ...t,
                        fundName: fund.name // Add fund name for the report
                    }))
                );
                return allTransactions;
            }, [funds]);
            
            // Render logic based on app state
            if (!db || !userId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h2 className="text-xl font-bold text-gray-800">در حال اتصال...</h2>
                            <p className="text-sm text-gray-500 mt-2">لطفاً صبر کنید تا برنامه بارگذاری شود.</p>
                            <p className="text-sm text-gray-500 mt-2">شناسه کاربری: {userId || 'در حال دریافت...'}</p>
                        </div>
                    </div>
                );
            }

            if (selectedFund) {
                return ( 
                <FundDetail 
                    fund={selectedFund} 
                    balance={calculateBalance(selectedFund.transactions)} 
                    onBack={() => setSelectedFundId(null)} 
                    onAddTransaction={(type) => { setTransactionType(type); setAddTransactionModalOpen(true); }} 
                    onEditTransaction={(trans) => { setEditingTransaction(trans); setEditTransactionModalOpen(true); }}
                    formatCurrency={formatCurrency} 
                    isAddTransactionModalOpen={isAddTransactionModalOpen} 
                    onCloseAddTransactionModal={() => setAddTransactionModalOpen(false)} 
                    onAddTransactionSubmit={handleAddTransaction} 
                    transactionType={transactionType} 
                    isEditTransactionModalOpen={isEditTransactionModalOpen} 
                    onCloseEditTransactionModal={() => { setEditTransactionModalOpen(false); setEditingTransaction(null); }} 
                    onEditTransactionSubmit={handleEditTransaction} 
                    editingTransaction={editingTransaction} 
                    onSetRecurring={() => setIsSetRecurringModalOpen(true)}
                    isSetRecurringModalOpen={isSetRecurringModalOpen}
                    onCloseSetRecurringModal={() => setIsSetRecurringModalOpen(false)}
                    onSetRecurringSubmit={handleSetRecurringTransaction}
                />
                );
            }

            return (
                <div className="bg-gray-50 min-h-screen font-sans" dir="rtl">
                    {notification && (
                        <div className="fixed top-5 left-1/2 -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-6 py-3 rounded-full shadow-lg z-50 transition-opacity duration-300">
                            <p>{notification}</p>
                        </div>
                    )}
                    <div className="container mx-auto max-w-md p-4">
                        <Header title="صندوق‌های من" />
                        <div className="text-center text-sm text-gray-500 mb-4">
                            شناسه کاربری: {userId}
                        </div>
                        <div className="flex gap-4 mb-6">
                             <button onClick={handleExportToExcel} className="flex-1 flex items-center justify-center bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors" >
                                <ExcelIcon /> گزارش اکسل
                            </button>
                            <button onClick={() => setIsAutoReportModalOpen(true)} className="flex-1 flex items-center justify-center bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-600 transition-colors" >
                                <ReportIcon /> گزارش واریزهای خودکار
                            </button>
                        </div>
                        <FundList funds={funds} onSelectFund={setSelectedFundId} onDeleteFund={handleDeleteFund} calculateBalance={calculateBalance} formatCurrency={formatCurrency} />
                        <FloatingActionButton onClick={() => setAddFundModalOpen(true)} />
                        {isAddFundModalOpen && <AddFundModal onClose={() => setAddFundModalOpen(false)} onAdd={handleAddFund} />}
                        {isConfirmDeleteModalOpen && (
                            <ConfirmationModal message="آیا از حذف این صندوق مطمئن هستید؟ تمام تراکنش‌های آن نیز حذف خواهد شد." onConfirm={handleConfirmDelete} onCancel={() => { setConfirmDeleteModalOpen(false); setFundToDeleteId(null); }} />
                        )}
                         {isAutoReportModalOpen && (
                            <AutoReportModal 
                                onClose={() => setIsAutoReportModalOpen(false)} 
                                transactions={autoTransactions}
                                formatCurrency={formatCurrency}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // --- Components ---
        const Header = ({ title, onBack }) => (
            <header className="bg-white shadow-sm rounded-lg p-4 mb-6 flex items-center justify-between sticky top-4 z-10">
                <h1 className="text-2xl font-bold text-gray-800">{title}</h1>
                {onBack && (
                    <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100">
                        <BackIcon />
                    </button>
                )}
            </header>
        );

        const FundList = ({ funds, onSelectFund, onDeleteFund, calculateBalance, formatCurrency }) => (
            <main className="space-y-4">
                {funds.length === 0 ? (
                    <div className="text-center py-10 px-4 bg-white rounded-lg shadow-sm">
                        <p className="text-gray-500">هیچ صندوقی وجود ندارد.</p>
                        <p className="text-gray-400 text-sm mt-2">برای شروع، روی دکمه + کلیک کنید.</p>
                    </div>
                ) : (
                    funds.map(fund => (
                        <div key={fund.id} onClick={() => onSelectFund(fund.id)} className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow cursor-pointer">
                            <div className="flex justify-between items-center mb-2">
                                <h2 className="text-lg font-bold text-gray-800">{fund.name}</h2>
                                <button onClick={(e) => { e.stopPropagation(); onDeleteFund(fund.id); }} className="text-sm text-red-500 hover:text-red-700">
                                    <TrashIcon />
                                </button>
                            </div>
                            <div className="text-gray-600">
                                <p>موجودی: <span className="font-bold text-green-600">{formatCurrency(calculateBalance(fund.transactions))}</span></p>
                            </div>
                        </div>
                    ))
                )}
            </main>
        );

        const FloatingActionButton = ({ onClick }) => (
            <button onClick={onClick} className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors">
                <PlusIcon />
            </button>
        );

        const AddFundModal = ({ onClose, onAdd }) => {
            const [fundName, setFundName] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(fundName);
            };
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">افزودن صندوق جدید</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="text" value={fundName} onChange={(e) => setFundName(e.target.value)} placeholder="نام صندوق" className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" />
                            <div className="flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">انصراف</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">افزودن</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                    <p className="text-gray-800 mb-6">{message}</p>
                    <div className="flex justify-center space-x-4 space-x-reverse">
                        <button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">خیر</button>
                        <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">بله، حذف کن</button>
                    </div>
                </div>
            </div>
        );

        const FundDetail = ({ fund, balance, onBack, onAddTransaction, onEditTransaction, formatCurrency, isAddTransactionModalOpen, onCloseAddTransactionModal, onAddTransactionSubmit, transactionType, isEditTransactionModalOpen, onCloseEditTransactionModal, onEditTransactionSubmit, editingTransaction, onSetRecurring, isSetRecurringModalOpen, onCloseSetRecurringModal, onSetRecurringSubmit }) => (
            <div className="min-h-screen font-sans bg-gray-50" dir="rtl">
                <div className="container mx-auto max-w-md p-4">
                    <Header title={fund.name} onBack={onBack} />
                    <div className="bg-white rounded-lg shadow-sm p-4 mb-6 text-center">
                        <h2 className="text-lg text-gray-600">موجودی فعلی</h2>
                        <p className="text-3xl font-bold text-green-600 mt-2">{formatCurrency(balance)}</p>
                    </div>
                    <div className="flex gap-4 mb-6">
                        <button onClick={() => onAddTransaction('deposit')} className="flex-1 flex items-center justify-center bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                            <ArrowUpIcon /> واریز
                        </button>
                        <button onClick={() => onAddTransaction('withdrawal')} className="flex-1 flex items-center justify-center bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            <ArrowDownIcon /> برداشت
                        </button>
                        <button onClick={onSetRecurring} className="flex-1 flex items-center justify-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                            <RepeatIcon /> تنظیم دوره‌ای
                        </button>
                    </div>
                    
                    <h3 className="text-lg font-bold text-gray-800 mb-2">تراکنش‌ها</h3>
                    <div className="bg-white rounded-lg shadow-sm">
                        {fund.transactions.length === 0 ? (
                            <div className="text-center py-10 px-4 text-gray-500">
                                <p>هیچ تراکنشی ثبت نشده است.</p>
                            </div>
                        ) : (
                            fund.transactions.map(trans => (
                                <div key={trans.id} className="flex items-center justify-between p-4 border-b last:border-0">
                                    <div className="flex items-center space-x-3 space-x-reverse">
                                        {trans.type === 'deposit' || trans.type === 'auto_deposit' ? <ArrowUpIcon /> : <ArrowDownIcon />}
                                        <div>
                                            <p className="font-bold text-gray-800">{formatCurrency(trans.amount)}</p>
                                            <p className="text-sm text-gray-500 mt-1">{trans.description}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2 space-x-reverse">
                                        <p className="text-sm text-gray-400">{trans.date}</p>
                                        <button onClick={() => onEditTransaction(trans)} className="p-1">
                                            <EditIcon />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    {isAddTransactionModalOpen && <AddTransactionModal onClose={onCloseAddTransactionModal} onAdd={onAddTransactionSubmit} type={transactionType} />}
                    {isEditTransactionModalOpen && <EditTransactionModal onClose={onCloseEditTransactionModal} onEdit={onEditTransactionSubmit} transaction={editingTransaction} />}
                    {isSetRecurringModalOpen && <SetRecurringModal onClose={onCloseSetRecurringModal} onSet={onSetRecurringSubmit} />}
                </div>
            </div>
        );

        const AddTransactionModal = ({ onClose, onAdd, type }) => {
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(amount, description);
            };
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">{type === 'deposit' ? 'واریز جدید' : 'برداشت جدید'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">مبلغ</label>
                                <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr" />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">توضیحات (اختیاری)</label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div className="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">انصراف</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ثبت</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const EditTransactionModal = ({ onClose, onEdit, transaction }) => {
            const [amount, setAmount] = useState(transaction.amount);
            const [description, setDescription] = useState(transaction.description);
            const handleSubmit = (e) => {
                e.preventDefault();
                onEdit(transaction.id, amount, description);
            };
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">ویرایش تراکنش</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">مبلغ</label>
                                <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr" />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">توضیحات</label>
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div className="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">انصراف</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ثبت تغییرات</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const SetRecurringModal = ({ onClose, onSet }) => {
            const [amount, setAmount] = useState('');
            const [frequency, setFrequency] = useState('monthly');
            const handleSubmit = (e) => {
                e.preventDefault();
                onSet('deposit', amount, frequency);
            };
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">تنظیم واریز دوره‌ای</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">مبلغ</label>
                                <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr" />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">دوره</label>
                                <select value={frequency} onChange={(e) => setFrequency(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="daily">روزانه</option>
                                    <option value="weekly">هفتگی</option>
                                    <option value="monthly">ماهانه</option>
                                </select>
                            </div>
                            <div className="mt-6 flex justify-end space-x-3 space-x-reverse">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">انصراف</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ثبت قانون</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const AutoReportModal = ({ onClose, transactions, formatCurrency }) => {
            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = a.timestamp ? a.timestamp.toDate() : new Date();
                const dateB = b.timestamp ? b.timestamp.toDate() : new Date();
                return dateB - dateA;
            });
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">گزارش واریزهای خودکار</h2>
                        <div className="max-h-80 overflow-y-auto space-y-3">
                            {sortedTransactions.length === 0 ? (
                                <p className="text-center text-gray-500">هیچ واریز خودکاری وجود ندارد.</p>
                            ) : (
                                sortedTransactions.map((trans, index) => (
                                    <div key={index} className="bg-gray-100 rounded-lg p-3 flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-sm text-gray-800">{formatCurrency(trans.amount)}</p>
                                            <p className="text-xs text-gray-500 mt-1">{trans.description} - {trans.fundName}</p>
                                        </div>
                                        <p className="text-xs text-gray-400">{trans.date}</p>
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">بستن</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- This line renders your App component into the 'root' div ---
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

